## Define the stages & order of execution

stages:
  - CLUSTER-SETUP
  - PROVIDER-INFRA-SETUP
  - APP-FUNC-TEST
  - APP-CHAOS-TEST
  - INFRA-CHAOS
  - CLUSTER-CLEANUP

###############################################################################

1CC01-konvoy-cluster:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-SETUP
  tags: 
    - k8s-konvoy 
  script:
    - chmod 755 ./openebs-konvoy-e2e/stages/1-cluster-setup/1CC01-cluster-setup
    - ./openebs-konvoy-e2e/stages/1-cluster-setup/1CC01-cluster-setup

###############################################################################

## Setup OpenEBS control plane

.infra_test_template:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - 1CC01-konvoy-cluster 

2IC01-OPENEBS-KONVOY-DEPLOY:
  extends: .infra_test_template
  script: 
    - chmod 755 ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC01-openebs-deploy
    - ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC01-openebs-deploy

2IC02-STRIPED-POOL:
  extends: .infra_test_template
  script:
   - chmod 755 ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC02-create-striped-pool
   - ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC02-create-striped-pool

2IC03-MIRRORED-POOL:
  extends: .infra_test_template
  script:
   - chmod 755 ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC03-create-mirrored-pool
   - ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC03-create-mirrored-pool

2IC04-RAIDZ1-POOL:
  extends: .infra_test_template
  script:
   - chmod 755 ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC04-create-raidz1-pool
   - ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC04-create-raidz1-pool
 
2IC05-RAIDZ2-POOL:
  extends: .infra_test_template
  script:
    - chmod 755 ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC05-create-raidz2-pool
    - ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC05-create-raidz2-pool

2IC06-OPENEBS-SC-DEPLOY:
  extends: .infra_test_template
  script:
   - chmod 755 ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC06-storage-policies
   - ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC06-storage-policies

2IC07-NFSv4-PROVISION:
  extends: .infra_test_template
  script:
   - chmod 755 ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC07-create-nfs-provisioner
   - ./openebs-konvoy-e2e/stages/2-Infra-setup/2IC07-create-nfs-provisioner

###############################################################################

# ## Define job template for func jobs    
.func_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-FUNC-TEST
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - 1CC01-konvoy-cluster  

3FC01-cvr-scaleup:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC01-cvr-scaleup
    - ./openebs-konvoy-e2e/stages/3-functional/3FC01-cvr-scaleup

3FC02-cvr-migration:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC02-cvr-migration
    - ./openebs-konvoy-e2e/stages/3-functional/3FC02-cvr-migration

3FC03-cvr-scaledown:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC03-cvr-scaledown
    - ./openebs-konvoy-e2e/stages/3-functional/3FC03-cvr-scaledown
    
3FC04-CAS-parameters:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC04-CAS-parameters
    - ./openebs-konvoy-e2e/stages/3-functional/3FC04-CAS-parameters

3FC05-create-cstor-snapshot:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC05-create-cstor-snapshot
    - ./openebs-konvoy-e2e/stages/3-functional/3FC05-create-cstor-snapshot

3FC06-create-cstor-clone:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC06-create-cstor-clone
    - ./openebs-konvoy-e2e/stages/3-functional/3FC06-create-cstor-clone

3FC07-clone-different-capacity:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC07-clone-different-capacity
    - ./openebs-konvoy-e2e/stages/3-functional/3FC07-clone-different-capacity

3FC08-Clone-parent-vol-delete:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC08-clone-parent-volume-delete
    - ./openebs-konvoy-e2e/stages/3-functional/3FC08-clone-parent-volume-delete 

3FC09-cStor-thick-provisioning:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC09-cstor-thick-provisioning
    - ./openebs-konvoy-e2e/stages/3-functional/3FC09-cstor-thick-provisioning 

3FC10-STS-App-Target-Affinity:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC10-sts-app-target-affinity
    - ./openebs-konvoy-e2e/stages/3-functional/3FC10-sts-app-target-affinity

3FC11-STS-Volume-Distribution:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC11-sts-volume-distribution
    - ./openebs-konvoy-e2e/stages/3-functional/3FC11-sts-volume-distribution

3FC12-cstor-Data-Integrity:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC12-cstor-data-integrity
    - ./openebs-konvoy-e2e/stages/3-functional/3FC12-cstor-data-integrity   

3FC14-scale-sts-replicas:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC14-scale-sts-replicas
    - ./openebs-konvoy-e2e/stages/3-functional/3FC14-scale-sts-replicas

3FC15-backup-and-restore:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC15-backup-restore
    - ./openebs-konvoy-e2e/stages/3-functional/3FC15-backup-restore

3FC16-rwx-app-deploy:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC16-rwx-app-deploy
    - ./openebs-konvoy-e2e/stages/3-functional/3FC16-rwx-app-deploy

3FC18-cstor-memory-consumption:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FC18-cstor-memory-consumption
    - ./openebs-konvoy-e2e/stages/3-functional/3FC18-cstor-memory-consumption
    
###############################################################################

# ## Define job template for chaos jobs 

.chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-CHAOS-TEST
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - 1CC01-konvoy-cluster 
  
4CC02-cStor-target-kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC02-cstor-target-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC02-cstor-target-kill

4CC03-target-network-delay:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC03-cstor-target-network-delay
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC03-cstor-target-network-delay

4CC04-cstor-volume-istgt-kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC04-cstor-volume-istgt-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC04-cstor-volume-istgt-kill

4CC05-cstor-volume-mgmt-kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC05-cstor-volume-mgmt-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC05-cstor-volume-mgmt-kill

4CC06-nfs-app-kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC06-nfs-application-pod-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC06-nfs-application-pod-kill

4CC07-Snap-Rebuild-single-replica:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC07-snap-rebuild-single-replica
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC07-snap-rebuild-single-replica

4CC08-snap-rebuild-multiple-rep:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC08-snap-rebuild-multiple-replica
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC08-snap-rebuild-multiple-replica

4CC09-clone-post-snap-rebuild:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC09-clone-post-snap-rebuild
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC09-clone-post-snap-rebuild

4CC10-cStor-Pool-Delete:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC10-cstor-pool-delete
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC10-cstor-pool-delete

4CC11-cStor-Pool-Kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CC11-cstor-pool-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CC11-cstor-pool-kill

###############################################################################

.infra_chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: INFRA-CHAOS
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - 1CC01-konvoy-cluster 

5ICC01-cstor-node-failure:
  extends: .infra_chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICC01-node-failure-cstor
    - ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICC01-node-failure-cstor

5ICC02-cstor-containerd-failure:
  extends: .infra_chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICC02-containerd-failure-cstor
    - ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICC02-containerd-failure-cstor
    
5ICC03-cstor-kubelet-failure:
  extends: .infra_chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICC03-kubelet-failure-cstor
    - ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICC03-kubelet-failure-cstor
    
###############################################################################

6CC01-konvoy-cleanup:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-CLEANUP
  when: always  
  dependencies: 
    - 1CC01-konvoy-cluster
  tags: 
    - k8s-konvoy 
  script:
    - chmod 755 ./openebs-konvoy-e2e/stages/10-cleanup/6CC01-cluster-cleanup
    - ./openebs-konvoy-e2e/stages/10-cleanup/6CC01-cluster-cleanup

