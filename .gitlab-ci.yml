## Define the stages & order of execution
## Job ID's are in following format
## pipeline_stage_no + J (for jiva) + S/P/F/C/I/D + job count
## S ==> Setup cluster
## P ==> Provider setup
## F ==> Functional tests
## C ==> Chaos test
## I ==> Infra-chaos test
## D ==> Cluster deletion or revert

stages:
  - CLUSTER-SETUP
  - PROVIDER-INFRA-SETUP
  - APP-FUNC-TEST
  - APP-CHAOS-TEST
  - INFRA-CHAOS
  - CLUSTER-CLEANUP

###############################################################################

1JS01-KONVOY-CLUSTER:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-SETUP
  tags: 
    - k8s-konvoy 
  script:
    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/1-cluster-setup/1JS01-cluster-setup/cluster-setup
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/1-cluster-setup/1JS01-cluster-setup/cluster-setup

###############################################################################

## Setup OpenEBS control plane

2JP01-OPENEBS-KONVOY-DEPLOY:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - 1JS01-KONVOY-CLUSTER
  script: 
    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/2JP01-openebs-deploy/openebs-deploy
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/2JP01-openebs-deploy/openebs-deploy

2JP02-OPENEBS-STORAGE-CLASSES:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - 1JS01-KONVOY-CLUSTER
  script: 
    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/2JP02-storage-classes/storage-classes
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/2JP02-storage-classes/storage-classes

###############################################################################

# ## Define job template for func jobs    
.func_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-FUNC-TEST
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - 1JS01-KONVOY-CLUSTER  

3JF01-JIVA-APP-TARGET-AFFINITY:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF01-Jiva-App-Target-Affinity/Jiva-App-Target-Affinity
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF01-Jiva-App-Target-Affinity/Jiva-App-Target-Affinity

3JF02-JIVA-REPLICA-SCALEUP:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF02-jiva-replica-scaleup/jiva-replica-scaleup
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF02-jiva-replica-scaleup/jiva-replica-scaleup

3JF03-JIVA-APP-REPLICA-SCALEUP:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF03-Jiva-App-replica-Scaleup/Jiva-App-replica-Scaleup
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF03-Jiva-App-replica-Scaleup/Jiva-App-replica-Scaleup

3JF04-JIVA-DATA-INTEGRITY:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF04-Jiva-Data-Integrity/data-integrity
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF04-Jiva-Data-Integrity/data-integrity

3JF05-JIVA-AUTOGEN-SNAPSHOT-DELETE:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF05-Jiva-internal-snapshot-deletion/Jiva-internal-snapshot-deletion
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF05-Jiva-internal-snapshot-deletion/Jiva-internal-snapshot-deletion

3JF06-JIVA-VOLUME-RESIZE:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF06-jiva-volume-resize/jiva-volume-resize
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF06-jiva-volume-resize/jiva-volume-resize

3JF07-JIVA-MEMORY-CONSUMPTION:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF07-Jiva-Memory-Consumption/memory-consumption
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF07-Jiva-Memory-Consumption/memory-consumption

3JF08-JIVA-SNAPSHOT:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF08-jiva-snapshot/jiva-snapshot
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF08-jiva-snapshot/jiva-snapshot

3JF09-JIVA-CLONE:
  extends: .func_test_template
  script: 
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF09-jiva-clone/jiva-clone
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/3JF09-jiva-clone/jiva-clone

###############################################################################

# ## Define job template for chaos jobs 

.chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-CHAOS-TEST
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - 1JS01-KONVOY-CLUSTER 
  
4JC01-JIVA-CONTROLLER-FAILURE:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC01-jiva-controller-failure/controller-failure
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC01-jiva-controller-failure/controller-failure

4JC02-JIVA-SINGLE-REPLICA-FAILURE:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC02-jiva-single-replica-failure/jiva-single-replica-failure
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC02-jiva-single-replica-failure/single-replica-failure

4JC03-JIVA-REPLICA-FAILURE:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC03-Jiva-replica-failure/jiva-replica-failure
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC03-Jiva-replica-failure/jiva-replica-failure

4JC04-JIVA-REPLICA-NODE-AFFINITY:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC04-jiva-replica-node-affinity/replica-node-affinity
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-chaos/4JC04-jiva-replica-node-affinity/replica-node-affinity

###############################################################################

.infra_chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: INFRA-CHAOS
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - 1JS01-KONVOY-CLUSTER 

5JI01-JIVA-CONTAINERD-FAILURE:
  extends: .infra_chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-infra-chaos/5JI01-containerd-failure-jiva/containerd-failure-jiva
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-infra-chaos/5JI01-containerd-failure-jiva/containerd-failure-jiva
    
5JI02-JIVA-KUBELET-FAILURE:
  extends: .infra_chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-infra-chaos/5JI02-kubelet-failure-jiva/kubelet-failure-jiva
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-infra-chaos/5JI02-kubelet-failure-jiva/kubelet-failure-jiva

# 5JI03-jiva-node-failure:
#   extends: .infra_chaos_test_template
#   script:
#     - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-infra-chaos/5JI03-node-failure-jiva/node-failure-jiva
#     - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-infra-chaos/5JI03-node-failure-jiva/node-failure-jiva

###############################################################################

6JD01-KONVOY-CLEANUP:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-CLEANUP
  when: always  
  dependencies: 
    - 1JS01-KONVOY-CLUSTER
  tags: 
    - k8s-konvoy 
  script:
    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/6-cleanup/6JD01-cluster-cleanup/cluster-cleanup
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/6-cleanup/6JD01-cluster-cleanup/cluster-cleanup
