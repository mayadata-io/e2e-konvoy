## Define the stages & order of execution

stages:
  - CLUSTER-SETUP
  - INFRA-SETUP
  - FUNCTIONAL
  - CHAOS
  - INFRA-CHAOS
  - CLUSTER-CLEANUP
  
##########################################################################################

1CJO01-Konvoy:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-SETUP
  tags:
    - k8s-konvoy  
  script:     
    - chmod 755 ./openebs-konvoy-e2e/stages/1-cluster-setup/1CJO01-cluster-setup
    - ./openebs-konvoy-e2e/stages/1-cluster-setup/1CJO01-cluster-setup

##########################################################################################

.jiva_csi_infra_setup_template:
  image: openebs/openshift-ci:latest
  stage: INFRA-SETUP
  tags:
    - k8s-konvoy  
  when: always
  dependencies:
    - 1CJO01-Konvoy

2IJO01-OpenEBS-Deploy:
  extends: .jiva_csi_infra_setup_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO01-openebs-deploy
    - ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO01-openebs-deploy

2IJO02-JIVA-OPERATOR:
  extends: .jiva_csi_infra_setup_template
  script:
    - chmod 755 ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO02-jiva-operator
    - ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO02-jiva-operator

2IJO03-STORAGE-POLICIES:
  extends: .jiva_csi_infra_setup_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO03-storage-policies
    - ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO03-storage-policies

2IJO04-NFSv4-JIVA-PROVISION:
  extends: .jiva_csi_infra_setup_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO04-nfsv4-jiva-provision
    - ./openebs-konvoy-e2e/stages/2-infra-setup/2IJO04-nfsv4-jiva-provision
  
###########################################################################################

.func_test_template:
  image: openebs/openshift-ci:latest
  stage: FUNCTIONAL
  tags:
    - k8s-konvoy  
  when: always
  dependencies:
    - 1CJO01-Konvoy

3FJO01-App-Deploy-Jiva-RWX:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FJO01-app-deploy-jiva-rwx
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO01-app-deploy-jiva-rwx

3FJO02-Jiva-App-Scaleup:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FJO02-app-replica-scaleup
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO02-app-replica-scaleup

3FJO03-Backup-Restore-Jiva:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FJO03-backup-restore-jiva
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO03-backup-restore-jiva

3FJO04-Jiva-Data-Integrity:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FJO04-data-integrity
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO04-data-integrity

3FJO05-JIVA-CSI-VOLUME-RESIZE:
  extends: .func_test_template
  script:
    - chmod 755 ./openebs-konvoy-e2e/stages/3-functional/3FJO05-jiva-csi-volume-resize
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO05-jiva-csi-volume-resize

3FJO06-JIVA-CSI-VOLUME-RESIZE-XFS:
  extends: .func_test_template
  script:
    - chmod 755 ./openebs-konvoy-e2e/stages/3-functional/3FJO06-jiva-csi-volume-resize-xfs
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO06-jiva-csi-volume-resize-xfs

3FJCO07-Jiva-Volume-Scaleup:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FJO07-jiva-volume-scaleup
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO07-jiva-volume-scaleup

3FJO08-Jiva-Memory-Consumption:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/3-functional/3FJO08-memory-consumption
    - ./openebs-konvoy-e2e/stages/3-functional/3FJO08-memory-consumption

###########################################################################################
.chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: CHAOS
  tags:
    - k8s-konvoy  
  when: always
  dependencies:
    - 1CJO01-Konvoy

4CJO01-Jiva-controller-kill:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO01-controller-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO01-controller-kill

4CJO02-Jiva-controller-delete:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO02-controller-delete
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO02-controller-delete

4CJO03-App-Kill:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO03-Jiva-app-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO03-Jiva-app-kill

4CJO04-Jiva-replica-failure:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO04-jiva-replica-failure
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO04-jiva-replica-failure

4CJO05-Jiva-Revision-Counter:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO05-jiva-revision-counter
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO05-jiva-revision-counter

4CJO06-nfs-App-Kill-Jiva:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO06-nfs-app-kill-jiva
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO06-nfs-app-kill-jiva

4CJO07-nfs-Ctrl-Kill-Jiva:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO07-nfs-ctrl-kill-jiva
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO07-nfs-ctrl-kill-jiva

4CJO08-nfs-Ctrl-Container-Kill-Jiva:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO08-nfs-ctrl-container-kill
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO08-nfs-ctrl-container-kill

4CJO09-Jiva-replica-node-affinity:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/4-chaos/4CJO09-replica-node-affinity
    - ./openebs-konvoy-e2e/stages/4-chaos/4CJO09-replica-node-affinity

.infra_chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: INFRA-CHAOS
  tags:
    - k8s-konvoy  
  when: always
  dependencies:
    - 1CJO01-Konvoy

5ICJO01-node-failure:
  extends: .infra_chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICJO01-node-failure
    - ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICJO01-node-failure

5ICJO02-containerd-failure:
  extends: .infra_chaos_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICJO02-containerd-failure-csi-jiva
    - ./openebs-konvoy-e2e/stages/5-infra-chaos/5ICJO02-containerd-failure-csi-jiva   

6CJO01-cluster-Delete:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-CLEANUP
  tags:
    - k8s-konvoy  
  when: always
  dependencies:
    - 1CJO01-Konvoy
  script:
    - chmod 775 ./openebs-konvoy-e2e/stages/7-cleanup/cluster-cleanup
    - ./openebs-konvoy-e2e/stages/7-cleanup/cluster-cleanup
