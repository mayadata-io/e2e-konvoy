## Define the stages & order of execution

stages:
  - CLUSTER-SETUP
  - PROVIDER-INFRA-SETUP
  - APP-FUNC-TEST
  - UPGRADE-OPENEBS
  - APP-CHAOS-TEST
  - CLUSTER-CLEANUP

konvoy-cluster:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-SETUP
  tags: 
    - k8s-konvoy 
  script:
    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/1-cluster-setup/cluster-setup/cluster-setup
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/1-cluster-setup/cluster-setup/cluster-setup

## Setup OpenEBS control plane

OPENEBS-KONVOY-DEPLOY:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - konvoy-cluster
  script: 
    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/openebs-deploy/infra-setup
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/openebs-deploy/infra-setup

OPENEBS-SC-DEPLOY:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - konvoy-cluster
  script:
   - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/storage-policies/openebs-sc
   - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/storage-policies/openebs-sc

STRIPED-POOL:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - konvoy-cluster
  script:
   - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-striped-pool/create-striped-pool
   - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-striped-pool/create-striped-pool

MIRRORED-POOL:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - konvoy-cluster
  script:
   - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-mirrored-pool/create-mirrored-pool
   - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-mirrored-pool/create-mirrored-pool

RAIDZ1-POOL:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - konvoy-cluster
  script:
   - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-raidz1-pool/create-raidz1-pool
   - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-raidz1-pool/create-raidz1-pool

RAIDZ2-POOL:
  image: openebs/openshift-ci:latest
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-konvoy
  dependencies:
    - konvoy-cluster
  script:
   - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-raidz2-pool/create-raidz2-pool
   - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-raidz2-pool/create-raidz2-pool

# NFSv4-PROVISION:
#   image: openebs/openshift-ci:latest
#   stage: PROVIDER-INFRA-SETUP
#   tags: 
#     - k8s-konvoy
#   dependencies:
#     - konvoy-cluster
#   script:
#    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-nfs-provisioner/nfsv4-provision
#    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-nfs-provisioner/nfsv4-provision

# CSPC-STRIPE-POOL:
#   image: openebs/openshift-ci:latest
#   stage: PROVIDER-INFRA-SETUP
#   tags: 
#     - k8s-konvoy
#   dependencies:
#     - konvoy-cluster
#   script:
#     - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-cspc-stripe-pool/create-cspc-stripe-pool
#     - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/create-cspc-stripe-pool/create-cspc-stripe-pool
 
# CSI-PROVISIONER:
#   image: openebs/openshift-ci:latest
#   stage: PROVIDER-INFRA-SETUP
#   tags: 
#     - k8s-konvoy
#   dependencies:
#     - konvoy-cluster
#   script:
#    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/deploy-csi-provisioner/deploy-csi-provisioner
#    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/2-Infra-setup/deploy-csi-provisioner/deploy-csi-provisioner

# ## Define job template for func jobs    
.func_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-FUNC-TEST
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - konvoy-cluster  

busybox-deployment-cstor:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-deployment-cstor/busybox-deployment-cstor
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-deployment-cstor/busybox-deployment-cstor

busybox-deployment-jiva:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-deployment-jiva/busybox-deployment-jiva
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-deployment-jiva/busybox-deployment-jiva

percona-deployment-cstor:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/percona-deployment-cstor/percona-deployment-cstor
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/percona-deployment-cstor/percona-deployment-cstor

percona-deployment-jiva:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/percona-deployment-jiva/percona-deployment-jiva
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/percona-deployment-jiva/percona-deployment-jiva

busybox-statefulset-cstor:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-statefulset-cstor/busybox-statefulset-cstor
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-statefulset-cstor/busybox-statefulset-cstor

busybox-statefulset-jiva:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-statefulset-jiva/busybox-statefulset-jiva
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-statefulset-jiva/busybox-statefulset-jiva

busybox-cstor-clone:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-cstor-clone/busybox-cstor-clone
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-cstor-clone/busybox-cstor-clone

busybox-cstor-snapshot:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-cstor-snapshot/busybox-cstor-snapshot
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-cstor-snapshot/busybox-cstor-snapshot

busybox-jiva-snapshot:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-jiva-snapshot/busybox-jiva-snapshot
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/3-functional/busybox-jiva-snapshot/busybox-jiva-snapshot

.upgrade_openebs:
  image: openebs/openshift-ci:latest
  stage: UPGRADE-OPENEBS
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - konvoy-cluster 

upgrade-control-plane:
  extends: .upgrade_openebs
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-upgrade-openebs/upgrade-control-plane
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-upgrade-openebs/upgrade-control-plane

upgrade-cstor:
  extends: .upgrade_openebs
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-upgrade-openebs/upgrade-cstor
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-upgrade-openebs/upgrade-cstor

upgrade-jiva:
  extends: .upgrade_openebs
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-upgrade-openebs/upgrade-jiva
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/4-upgrade-openebs/upgrade-jiva

.chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-CHAOS-TEST
  tags: 
    - k8s-konvoy
  when: always
  dependencies:
    - konvoy-cluster
    
busybox-controller-kill:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-controller-kill
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-controller-kill

busybox-target-kill:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-target-kill
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-target-kill

busybox-cstor-pool-kill:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-cstor-pool-kill
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-cstor-pool-kill

busybox-cstor-pool-delete:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-cstor-pool-delete
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-cstor-pool-delete

busybox-cstor-sts-verify-data-persistence:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-cstor-verify-data-persistence
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-cstor-verify-data-persistence

busybox-jiva-sts-verify-data-persistence:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-jiva-verify-data-persistence
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-jiva-verify-data-persistence

busybox-deployment-target-network-delay:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-deployment-target-nw-delay
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-deployment-target-nw-delay

busybox-deployment-controller-network-delay:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-deployment-controller-nw-delay
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/bb-deployment-controller-nw-delay

percona-target-network-delay:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/percona-target-nw-delay
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/percona-target-nw-delay

percona-controller-network-delay:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/percona-controller-nw-delay
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/5-chaos/percona-controller-nw-delay

konvoy-cleanup:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-CLEANUP
  when: always  
  dependencies: 
    - konvoy-cluster
  tags: 
    - k8s-konvoy 
  script:
    - chmod 755 ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/6-cleanup/cluster-cleanup/cluster-cleanup
    - ./openebs-konvoy-e2e/pipelines/OpenEBS-base/stages/6-cleanup/cluster-cleanup/cluster-cleanup
